BUILD_DIR=../.

export GIT_URL=$(shell sh -c 'git config --get remote.origin.url || echo "https://github.com/GAIA-UNIL/G2S.git"')

export SRCS=$(BUILD_DIR)/../src
export CFLAGS=-O3 -std=c++11 -fPIC
export CXXFLAGS=
export INC=-I$(BUILD_DIR)/../include
export LIBINC=-I/usr/include -I/usr/include/jsoncpp -I/opt/local/include
export LDFLAGS=-lzmq -lz -ljsoncpp -lcurl -lfftw3f -lfftw3f_threads -ldl -lpthread
export LIB_PATH= -L/usr/lib -L/opt/local/lib
export ARFLAGS= rcs



UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    OS =linux
    OPENCL_LIB= -lOpenCL -lclFFT
endif
ifeq ($(UNAME_S),Darwin)
    OS =mac
    OPENCL_LIB= -framework OpenCL -lclFFT
endif

export OS

dosentSupportOpenCL:= $(shell sh -c "echo 'int main(){}' | c++ -xc - -o /dev/null $OPENCL_LIB 2>/dev/null && echo 0 || echo 1 ")
ifeq ("$(dosentSupportOpenCL)","0")
	export OPENCL_INC=-DWITH_OPENCL=1
	export OPENCL_LIB
else
	OPENCL_LIB=''
endif

dosentSupportOMP:= $(shell sh -c 'echo "int main(){}" | c++ -xc - -o /dev/null -fopenmp 2>/dev/null && echo 0 || echo 1 ')
ifeq ("$(dosentSupportOMP)","0")
	CFLAGS += -fopenmp
	LDFLAGS += -fopenmp
endif

ifneq ("$(wildcard /usr/include/hbwmalloc.h)","")
export CFLAGS+= -DHBW_MALLOC
export LDFLAGS+= -lmemkind
endif

ifneq (,$(wildcard /usr/include/*/curl/curl.h /usr/include/curl/curl.h /opt/local/include/curl/curl.h))
	export CFLAGS+= -DWITH_VERSION_CONTROL -DCURRENT_VERSION=\"$(shell sh -c "cat ../version")\" -DGIT_URL=\"$(GIT_URL)\"
endif

DEFAULT_JOB=c++
ifneq ("$(shell sh -c 'icpc 2>/dev/null; echo $? ')","127")
	DEFAULT_JOB+=intel
endif

.DEFAULT_GOAL=default

.PHONY: c++ em intel c++-extension intel-extension extension python

.DEFAULT:
	$(MAKE) -C c++-build $@
	$(MAKE) -C intel-build $@

default: $(DEFAULT_JOB)

c++:
	$(MAKE) -C c++-build

em:
	emmake make -C em-build

intel:
	$(MAKE) -C intel-build

c++-extension:
	$(MAKE) -C c++-build extension

intel-extension:
	$(MAKE) -C intel-build extension

extension: c++-extension intel-extension

python:
	cd python-build && python3 setup.py build_ext --inplace
