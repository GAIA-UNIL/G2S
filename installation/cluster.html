<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WTZCWGE9PT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WTZCWGE9PT',{ 'anonymize_ip': true });
</script>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="/G2S/assets/css/style.css?v=" media="screen" type="text/css">
    <link rel="stylesheet" href="/G2S/assets/css/print.css" media="print" type="text/css">
    <link rel="stylesheet" href="/G2S/assets/css/g2s.css" media="screen" type="text/css">

    <script src="/G2S/assets/js/tabManager.js"></script>
    <script src="/G2S/assets/js/codeblock.js"></script>

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Server autostart | G2S: The GeoStatistical Server</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Server autostart" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A free and flexible multiple point (geo)statistics framework including state-of-the-art algorithms: QuickSampling and Narrow Distribution Selection" />
<meta property="og:description" content="A free and flexible multiple point (geo)statistics framework including state-of-the-art algorithms: QuickSampling and Narrow Distribution Selection" />
<link rel="canonical" href="https://gaia-unil.github.io//G2S/installation/cluster.html" />
<meta property="og:url" content="https://gaia-unil.github.io//G2S/installation/cluster.html" />
<meta property="og:site_name" content="G2S: The GeoStatistical Server" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Server autostart" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A free and flexible multiple point (geo)statistics framework including state-of-the-art algorithms: QuickSampling and Narrow Distribution Selection","headline":"Server autostart","url":"https://gaia-unil.github.io//G2S/installation/cluster.html"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'G-WTZCWGE9PT', 'auto');
    ga('send', 'pageview');
  </script>



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/G2S/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="https://gaia-unil.github.io//G2S/">
          <h1>G2S: The GeoStatistical Server</h1>
        </a>
        <h2>A free and flexible multiple point (geo)statistics framework including state-of-the-art algorithms: QuickSampling and Narrow Distribution Selection</h2>
        <div class="githubButton">
          
          <a href="https://github.com/GAIA-UNIL/G2S" class="button"><small>View project on</small> GitHub</a>
        
        
          <a href="https://github.com/GAIA-UNIL/G2S/zipball/master" class="button download"><small>Download</small>
              .zip file</a>
        
        
          <a href="https://github.com/GAIA-UNIL/G2S/tarball/master" class="button download"><small>Download</small>
              .tar.gz file</a>
        
        
        </div>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <aside id="menuSidebar" class="sideMenuBar">
          <nav class="navBar sideMenu">
          
          
          













<ul class="main">
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/briefOverview.html">Brief overview</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class=" sub">
      <a href="/G2S/installation.html">Installation</a>

      
        
        













<ul class="main">
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/installation/server.html">Installation of the server</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/installation/interfaces.html">Installation of interfaces</a>

      
        
      
    </li>
  
</ul>

      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/runTheServer.html">Run the server</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/usingTheInterfaces.html">Using the interfaces</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class=" sub">
      <a href="/G2S/algorithms.html">Algorithms</a>

      
        
        













<ul class="main">
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/algorithms/QuickSampling.html">QuickSampling</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/algorithms/NarrowDistributionSelection.html">Narrow Distribution Selection</a>

      
        
      
    </li>
  
    
    
    
    
    
    
    

    
      
    

        <li class="">
      <a href="/G2S/algorithms/AutoQS.html">AutoQS</a>

      
        
      
    </li>
  
</ul>

      
    </li>
  
</ul>

          
          
          </nav>
        </aside>
        <section id="main-content">
          <h1 id="server-autostart">Server autostart</h1>

<p>When running the server on a workstation, sometimes an automatic reboot may be needed (e.g., update, power cut, etc). To make matters worse, we may need to login to start again the server. In addition to machine reboots, sometimes servers can crash.</p>

<p>On Linux machines, it is possible to run the software in the background and launch it automatically at start-up. Here is the installation for Ubuntu, but it‚Äôs very simple to adapt it for other systems.</p>

<p>Many solutions exist with cron, etc., but my favorite one is with systemd</p>

<ol>
  <li>First follow the standard Linux installation.</li>
  <li>Test if everything works correctly.</li>
  <li>Create a new service, let‚Äôs call it G2S.service, to do so create a new file <code class="language-plaintext highlighter-rouge">/etc/systemd/system/G2S.service</code></li>
  <li>Paste the following code and it‚Äôs done:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [Unit]
 Description=G2S service
 After=network-online.target
 StartLimitIntervalSec=0

 [Service]
 Type=simple
 Restart=always
 RestartSec=1
 User=tesla-k20c
 # update {pathToTheServer} with the path where "./server" is located,
 # intel-build or c++-build, regarding your choice 
 WorkingDirectory={pathToTheServer}
 # if you use the Intel version, you probably want to load the libraries
 # like : /bin/bash -c "source /opt/Intel/parallel_studio_xe_2019/bin/psxevars.sh intel64; ./server -kod -age 864000"
 ExecStart=/bin/bash -c "./server -kod -age 864000"
 # -age 864000	==&gt; keep the file for 10 days
 # -kod		==&gt; don't remove old files in case of reboot or crash

 [Install]
 WantedBy=multi-user.target
</code></pre></div>    </div>
  </li>
  <li>Start the service with <code class="language-plaintext highlighter-rouge">systemctl start G2S</code></li>
  <li>Once everything works flawlessly, set it to start automatically at boot with <code class="language-plaintext highlighter-rouge">systemctl enable G2S</code></li>
  <li>Enjoy!</li>
</ol>

<h1 id="cluster">Cluster</h1>

<p>In this section, I will give you a brief overview of how to set up G2S on a cluster. In this mode, the computation is not distributed through the cluster, but runs on a single cluster node.</p>

<p>The installation on a cluster can be a quite difficult task. Please don‚Äôt hesitate to ask for help from the team that manages the cluster.</p>

<p>The installation really depends on what the cluster team allows you to do or not.</p>

<h2 id="installation-of-libraries">Installation of libraries</h2>

<p>In the best-case scenario, fftw3 is installed in a non-standard path (you may not find two clusters that have the stuff at the same place. Why? To make your life harder, of course! ü§™). Potentially you can have the Intel compiler installed with all the libraries. Please refer to your cluster documentation for this.</p>

<p>Probably ZMQ is not already installed, and don‚Äôt expect that they will install it for you. Also, jsoncpp is most probably missing too. In order to make life a bit easier for you, I prepared a small script that downloads and compiles all of these libraries and even modifies the Makefile.</p>

<ol>
  <li>Log in to a computation node (or submit a task).</li>
  <li>Execute the script in <code class="language-plaintext highlighter-rouge">build/forClusters/compileExternalLibs.sh</code> (I assume that the front and the computational nodes are from the same generation, in other cases you can run into some unsupported instruction issues).</li>
  <li>Wait until it‚Äôs finished, take this time to pray üôè to the god of the clusters.</li>
</ol>

<h2 id="compilation-of-g2s">Compilation of G2S</h2>

<p>The previous script updates the Makefile automatically, so refer to the standard Linux installation. ‚ö†Ô∏è Be careful to compile in a computational node and not on the front node; otherwise, you can have lots of painful issues later.</p>

<h2 id="execute-the-g2s-server">Execute the G2S server</h2>

<p>Take a deep breath and don‚Äôt give up; it‚Äôs almost finished!</p>

<p>Now the challenging part starts. It is highly dependent on how lucky you are and how much energy you want to spend to make it work. But keep this in mind, spending some time now can make you win a lot later.</p>

<h3 id="simple-ugly-and-inefficient-solution">Simple, ugly, and inefficient solution</h3>

<p>You can use this solution if you don‚Äôt have a queuing system. You really don‚Äôt? Are you sure you are on a cluster?</p>

<ol>
  <li>You simply start the G2S server on a node.</li>
  <li>Once it‚Äôs running, connect to the node using an ssh tunnel: <code class="language-plaintext highlighter-rouge">ssh -L 8128:theNodeName:8128 clusterAddress</code>, this will redirect your localhost to the computation node.</li>
  <li>Then run any G2S computation you like on your own computer.</li>
  <li>Once you have all your computation finished, shut down the server with the ‚Äò-shutdown‚Äô argument.
‚ö†Ô∏è Although this solution looks simple, in reality, it‚Äôs dangerous and relatively hard to use on a busy cluster. In fact, when you want to run the server, you will probably finish in the waiting queue. If you are paying for the computations, you would be charged even when it isn‚Äôt computing any simulation because the node is busy (waiting for jobs). And if you are not charged, you still use resources that other people may need. Furthermore, with this solution, it‚Äôs extremely difficult to distribute many jobs across all the clusters.
Using nodeParallel could be a (smoother) solution too, in particular for multiple node submission.</li>
</ol>

<h3 id="the-way-to-go">The way to go</h3>

<p>The goal here is to create a task for each simulation and to add it to the queue. Again each cluster is different, some use PBS (qsub), some use SLURM(sbatch, srun),‚Ä¶ (ok, it‚Äôs not the place to debate about this). We need to convert each call to an algorithm that doesn‚Äôt starts the computation, but instead submits it in the queue.</p>

<p>‚ö†Ô∏è currently computation interruption does not work on some clusters (Ctrl+C as well as ‚Äò-kill‚Äô). Therefore, you need to manage job interruptions with the submission queue system. I will try to fix this issue as soon as I can, however it‚Äôs not on my priority list now.</p>

<ol>
  <li>If the cluster uses PBS or SLURM, check the related file in the forClusters directory. If it uses another system, check one and adapt for your situation. I advise asking the cluster team to help you with this, and they are paid to do that. (please contact me only if they couldn‚Äôt find out how to make it work)</li>
  <li>if needed, adapt configureCluster.sh</li>
  <li>execute configureCluster.sh</li>
  <li>Open a tunnel to the front node ssh -L 8128:clusterAddress:8128 clusterAddress</li>
  <li>start the server ./server -kod -age 864000 (adjust the 864000 regarding how long the file needs to be stored on the cluster (here 10 days))</li>
  <li>Submit the jobs
 once all the jobs are submitted you can close the connection (it is possible that you run into trouble if you run many thousands of tasks at the same time, in that case keep the connection open)</li>
</ol>

<h3 id="even-better">even better</h3>

<p>If you are lucky you may be able to keep the server running all the time on the front node. Then ‚Ä¶.</p>

<p>You can try to run server in demons -d, if it‚Äôs authorized. So you can always cut the connection even if you submit one million tasks at the same time.</p>

<p>Then‚Ä¶ if you‚Äôre even luckier you can open a port on the front node (here 8128). Don‚Äôt hesitate to ask the support if they can do this favor for you. If you can, 1) invest in a good bottle of wine for the support department, 2) If you are that lucky you should play lottery!</p>

<p>So, once the port is open and the server are executed as a deamon, you can close all connections, and simply put the address of the front node in each call to g2s ‚Äò-sa‚Äô,clusterAddress</p>

<h2 id="how-to-efficiently-use-it">How to efficiently use it</h2>

<p>Once the server runs on the front node use ‚Äò‚ÄësubmitOnly‚Äô,‚Äô‚ÄëstatusOnly‚Äô and ‚Äò‚ÄëwaitAndDownload‚Äô to manage your computations. The G2S server is coming with its own submission queue and dependency manager. Because the dependencies are unknown, each job runs sequentially by default. To over pass this limitation we can simply specify dependency as :‚Äô‚Äëafter‚Äô,0, so each job can start in parallel.</p>

<p>A standard job submission should look like id=g2s(‚Ä¶ usualParameter,‚Äô‚ÄëstatusOnly‚Äô,‚Äô‚Äëafter‚Äô,0).
and to get the final result sim=g2s(‚Äò‚ÄëwaitAndDownload‚Äô,id)</p>

<h2 id="using-nodeparallel">Using nodeParallel</h2>
<p>NodeParallel (NP) allow to forward command from one node to another, in our context from the login node to some worker nodes (it require a shared file system). Therefore we can use NP to forward computation command to computation nodes without making a new task in the submission queue. This is particularly interesting when we have lots of short jobs (it allows removing the initialization for each task), or when we have significantly more jobs than the number of tasks that we are allowed to submit to the queue.</p>

<p>To use it simple download NP from its github page, follow the instruction to install and add it to the PATH (at least each time you want to use it :) ). Then adapt the compilation for use on cluster using ./configureCluster.sh NP available in the forClusters folder. This configuration is not compatible with a queue submission one, so if you plan to use both strategies in parallel you need to duplicate the G2S installation. Run the NP and G2S servers, both on the login node.</p>

<ol>
  <li>You can run NP in demon mode ./server -d</li>
  <li>When running the G2S server, add the -maxCJ n flag, with n between the number and few(&lt;4x) times the number of jobs you plan to run in parallel.</li>
  <li>Start (and you can even finish) to submit G2S tasks. (Refer to the previous sections to communicate with the login node, ssh tunneling, open ports on the login node ‚Ä¶). Don‚Äôt forget the ‚Äò-after‚Äô,0 to allow parallel computations.</li>
  <li>Finally, run workers by submitting tasks to the normal submission queue(or directly to the computation nodes ) using the np_client -sa $HOSTNAME -sac -w in the folder that contain the G2S server. With $HOSTNAME the name or IP of the login node.</li>
</ol>


        </section>
      </div>
    </div>
    <footer>
       
            <p class="repo-owner"><a href="https://github.com/GAIA-UNIL/G2S">G2S</a> is actively maintained by <a href="https://wp.unil.ch/gaia/">GAIA lab</a> at the <a href="https://www.unil.ch">University of Lausanne</a> and the <a href="https://www.oeaw.ac.at/igf">IGF</a> at the <a href="https://www.oeaw.ac.at/">Austrian Academy of Sciences</a>.</p>
          
    </footer>
  </body>
</html>